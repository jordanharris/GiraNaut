(function(){var a,b={}.hasOwnProperty,c=[].slice;null!=(null!=(a=this.google)?a.maps:void 0)&&(this.OverlappingMarkerSpiderfier=function(){function a(a,c){var e,f,g,h,i,j,k=this;this.map=a,null==c&&(c={});for(f in c)b.call(c,f)&&(g=c[f],this[f]=g);for(this.projHelper=new this.constructor.ProjHelper(this.map),this.initMarkerArrays(),this.listeners={},j=["click","zoom_changed","maptypeid_changed"],h=0,i=j.length;i>h;h++)e=j[h],d.addListener(this.map,e,function(){return k.unspiderfy()})}var d,e,f,g,h,i,j,k,l,m,n;for(i=a.prototype,n=[a,i],l=0,m=n.length;m>l;l++)k=n[l],k.VERSION="0.3.3";return e=google.maps,d=e.event,h=e.MapTypeId,j=2*Math.PI,i.keepSpiderfied=!1,i.markersWontHide=!1,i.markersWontMove=!1,i.nearbyDistance=20,i.circleSpiralSwitchover=9,i.circleFootSeparation=23,i.circleStartAngle=j/12,i.spiralFootSeparation=26,i.spiralLengthStart=11,i.spiralLengthFactor=4,i.spiderfiedZIndex=1e3,i.usualLegZIndex=10,i.highlightedLegZIndex=20,i.legWeight=1.5,i.legColors={usual:{},highlighted:{}},g=i.legColors.usual,f=i.legColors.highlighted,g[h.HYBRID]=g[h.SATELLITE]="#fff",f[h.HYBRID]=f[h.SATELLITE]="#f00",g[h.TERRAIN]=g[h.ROADMAP]="#444",f[h.TERRAIN]=f[h.ROADMAP]="#f00",i.initMarkerArrays=function(){return this.markers=[],this.markerListenerRefs=[]},i.addMarker=function(a){var b,c=this;return null!=a._oms?this:(a._oms=!0,b=[d.addListener(a,"click",function(b){return c.spiderListener(a,b)})],this.markersWontHide||b.push(d.addListener(a,"visible_changed",function(){return c.markerChangeListener(a,!1)})),this.markersWontMove||b.push(d.addListener(a,"position_changed",function(){return c.markerChangeListener(a,!0)})),this.markerListenerRefs.push(b),this.markers.push(a),this)},i.markerChangeListener=function(a,b){return null==a._omsData||!b&&a.getVisible()||null!=this.spiderfying||null!=this.unspiderfying?void 0:this.unspiderfy(b?a:null)},i.getMarkers=function(){return this.markers.slice(0)},i.removeMarker=function(a){var b,c,e,f,g;if(null!=a._omsData&&this.unspiderfy(),b=this.arrIndexOf(this.markers,a),0>b)return this;for(e=this.markerListenerRefs.splice(b,1)[0],f=0,g=e.length;g>f;f++)c=e[f],d.removeListener(c);return delete a._oms,this.markers.splice(b,1),this},i.clearMarkers=function(){var a,b,c,e,f,g,h,i,j;for(this.unspiderfy(),j=this.markers,a=f=0,h=j.length;h>f;a=++f){for(e=j[a],c=this.markerListenerRefs[a],g=0,i=c.length;i>g;g++)b=c[g],d.removeListener(b);delete e._oms}return this.initMarkerArrays(),this},i.addListener=function(a,b){var c,d;return(null!=(d=(c=this.listeners)[a])?d:c[a]=[]).push(b),this},i.removeListener=function(a,b){var c;return c=this.arrIndexOf(this.listeners[a],b),0>c||this.listeners[a].splice(c,1),this},i.clearListeners=function(a){return this.listeners[a]=[],this},i.trigger=function(){var a,b,d,e,f,g,h,i;for(b=arguments[0],a=2<=arguments.length?c.call(arguments,1):[],h=null!=(g=this.listeners[b])?g:[],i=[],e=0,f=h.length;f>e;e++)d=h[e],i.push(d.apply(null,a));return i},i.generatePtsCircle=function(a,b){var c,d,f,g,h,i,k;for(f=this.circleFootSeparation*(2+a),h=f/j,d=j/a,k=[],g=i=0;a>=0?a>i:i>a;g=a>=0?++i:--i)c=this.circleStartAngle+g*d,k.push(new e.Point(b.x+h*Math.cos(c),b.y+h*Math.sin(c)));return k},i.generatePtsSpiral=function(a,b){var c,d,f,g,h,i;for(f=this.spiralLengthStart,c=0,i=[],d=h=0;a>=0?a>h:h>a;d=a>=0?++h:--h)c+=this.spiralFootSeparation/f+5e-4*d,g=new e.Point(b.x+f*Math.cos(c),b.y+f*Math.sin(c)),f+=j*this.spiralLengthFactor/c,i.push(g);return i},i.spiderListener=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;if(f=null!=a._omsData,f&&this.keepSpiderfied||this.unspiderfy(),f||this.map.getStreetView().getVisible()||"GoogleEarthAPI"===this.map.getMapTypeId())return this.trigger("click",a,b);for(h=[],i=[],g=this.nearbyDistance,j=g*g,e=this.llToPt(a.position),m=this.markers,k=0,l=m.length;l>k;k++)c=m[k],null!=c.map&&c.getVisible()&&(d=this.llToPt(c.position),this.ptDistanceSq(d,e)<j?h.push({marker:c,markerPt:d}):i.push(c));return 1===h.length?this.trigger("click",a,b):this.spiderfy(h,i)},i.markersNearMarker=function(a,b){var c,d,e,f,g,h,i,j,k,l,m;if(null==b&&(b=!1),null==this.projHelper.getProjection())throw"Must wait for 'idle' event on map before calling markersNearMarker";for(g=this.nearbyDistance,h=g*g,e=this.llToPt(a.position),f=[],k=this.markers,i=0,j=k.length;j>i&&(c=k[i],!(c!==a&&null!=c.map&&c.getVisible()&&(d=this.llToPt(null!=(l=null!=(m=c._omsData)?m.usualPosition:void 0)?l:c.position),this.ptDistanceSq(d,e)<h&&(f.push(c),b))));i++);return f},i.markersNearAnyOtherMarker=function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u;if(null==this.projHelper.getProjection())throw"Must wait for 'idle' event on map before calling markersNearAnyOtherMarker";for(j=this.nearbyDistance,k=j*j,i=function(){var a,b,c,e,f,g;for(c=this.markers,g=[],a=0,b=c.length;b>a;a++)d=c[a],g.push({pt:this.llToPt(null!=(e=null!=(f=d._omsData)?f.usualPosition:void 0)?e:d.position),willSpiderfy:!1});return g}.call(this),r=this.markers,b=l=0,o=r.length;o>l;b=++l)if(e=r[b],null!=e.map&&e.getVisible()&&(f=i[b],!f.willSpiderfy))for(s=this.markers,c=m=0,p=s.length;p>m;c=++m)if(g=s[c],c!==b&&null!=g.map&&g.getVisible()&&(h=i[c],(!(b>c)||h.willSpiderfy)&&this.ptDistanceSq(f.pt,h.pt)<k)){f.willSpiderfy=h.willSpiderfy=!0;break}for(t=this.markers,u=[],a=n=0,q=t.length;q>n;a=++n)d=t[a],i[a].willSpiderfy&&u.push(d);return u},i.makeHighlightListenerFuncs=function(a){var b=this;return{highlight:function(){return a._omsData.leg.setOptions({strokeColor:b.legColors.highlighted[b.map.mapTypeId],zIndex:b.highlightedLegZIndex})},unhighlight:function(){return a._omsData.leg.setOptions({strokeColor:b.legColors.usual[b.map.mapTypeId],zIndex:b.usualLegZIndex})}}},i.spiderfy=function(a,b){var c,f,g,h,i,j,k,l,m,n,o;return this.spiderfying=!0,n=a.length,c=this.ptAverage(function(){var b,c,d;for(d=[],b=0,c=a.length;c>b;b++)l=a[b],d.push(l.markerPt);return d}()),h=n>=this.circleSpiralSwitchover?this.generatePtsSpiral(n,c).reverse():this.generatePtsCircle(n,c),o=function(){var b,c,l,n=this;for(l=[],b=0,c=h.length;c>b;b++)g=h[b],f=this.ptToLl(g),m=this.minExtract(a,function(a){return n.ptDistanceSq(a.markerPt,g)}),k=m.marker,j=new e.Polyline({map:this.map,path:[k.position,f],strokeColor:this.legColors.usual[this.map.mapTypeId],strokeWeight:this.legWeight,zIndex:this.usualLegZIndex}),k._omsData={usualPosition:k.position,leg:j},this.legColors.highlighted[this.map.mapTypeId]!==this.legColors.usual[this.map.mapTypeId]&&(i=this.makeHighlightListenerFuncs(k),k._omsData.hightlightListeners={highlight:d.addListener(k,"mouseover",i.highlight),unhighlight:d.addListener(k,"mouseout",i.unhighlight)}),k.setPosition(f),k.setZIndex(Math.round(this.spiderfiedZIndex+g.y)),l.push(k);return l}.call(this),delete this.spiderfying,this.spiderfied=!0,this.trigger("spiderfy",o,b)},i.unspiderfy=function(a){var b,c,e,f,g,h,i;if(null==a&&(a=null),null==this.spiderfied)return this;for(this.unspiderfying=!0,f=[],e=[],i=this.markers,g=0,h=i.length;h>g;g++)c=i[g],null!=c._omsData?(c._omsData.leg.setMap(null),c!==a&&c.setPosition(c._omsData.usualPosition),c.setZIndex(null),b=c._omsData.hightlightListeners,null!=b&&(d.removeListener(b.highlight),d.removeListener(b.unhighlight)),delete c._omsData,f.push(c)):e.push(c);return delete this.unspiderfying,delete this.spiderfied,this.trigger("unspiderfy",f,e),this},i.ptDistanceSq=function(a,b){var c,d;return c=a.x-b.x,d=a.y-b.y,c*c+d*d},i.ptAverage=function(a){var b,c,d,f,g,h;for(d=f=0,g=0,h=a.length;h>g;g++)c=a[g],d+=c.x,f+=c.y;return b=a.length,new e.Point(d/b,f/b)},i.llToPt=function(a){return this.projHelper.getProjection().fromLatLngToDivPixel(a)},i.ptToLl=function(a){return this.projHelper.getProjection().fromDivPixelToLatLng(a)},i.minExtract=function(a,b){var c,d,e,f,g,h,i;for(e=h=0,i=a.length;i>h;e=++h)f=a[e],g=b(f),("undefined"==typeof c||null===c||d>g)&&(d=g,c=e);return a.splice(c,1)[0]},i.arrIndexOf=function(a,b){var c,d,e,f;if(null!=a.indexOf)return a.indexOf(b);for(c=e=0,f=a.length;f>e;c=++e)if(d=a[c],d===b)return c;return-1},a.ProjHelper=function(a){return this.setMap(a)},a.ProjHelper.prototype=new e.OverlayView,a.ProjHelper.prototype.draw=function(){},a}())}).call(this);
//# sourceMappingURL=spiderfy.min.map